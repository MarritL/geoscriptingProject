---
title: "Explaining roe deer movement in the Italian alps"
authors: Anne-Juul Welsink and Marrit Leenstra
date: 31 January 2019
output: html_notebook
---

TODO:
Project description

```{r}
# check if libraries are installed
if (!require("dplyr")) install.packages("dplyr")
if (!require("sp")) install.packages("sp")
if (!require("sf")) install.packages("sf")
if (!require("DBI")) install.packages("DBI")
if (!require("RSQLite")) install.packages("RSQLite")
if (!require("raster")) install.packages("raster")
if (!require("adehabitatLT")) install.packages("adehabitatLT")
if (!require("lubridate")) install.packages("lubridate")
if (!require("ggplot2")) install.packages("ggplot2")
```

```{r}
# load libraries
library(dplyr)
library(sp)
library(sf)
library(DBI)
library(raster)
library(adehabitatLT)
library(lubridate)
library(ggplot2)
```

```{r}
# import functions
source("R/retrieveData.R")
source("R/saveDataInDB.R")
```

```{r}
# project variables
movementDataURL = "extras.springer.com/2014/978-3-319-03742-4/trackingDB_datasets.zip"
environmentalURL = "https://drive.google.com/uc?export=download&id=1fgH2ws_WoeDgMSDYCQNwvI6nzHjVagKc"
```

```{r}
# download movement data
folder = "data"
retrieveData(movementDataURL, folder)

# download environmental data
retrieveData(environmentalURL, folder)
```

```{r}
# Load environmental data to global environment
fileList <- list.files(path = "data/GoogleEarthData", pattern = glob2rx('*.tif'), full.names = TRUE)
DEM <- raster(fileList[1])
landUse <- raster(fileList[2])
slope <- raster(fileList[3])
```

We use roe deer movement data designed as an example dataset for a book about spatial database management (Urbano and Cagnacci, 2014). The data is thus designed for use in a database and set up as interlinking datasets. We decided to use the data as it was designed and set up a SQLite database in memory.

```{r}
# create database connection
movementDB <- dbConnect(RSQLite::SQLite(), "")

# get files
gpsData <- list.files(path = "data/tracking_db/data/sensors_data/", pattern = glob2rx('GSM0*.csv'), full.names = TRUE)
sensorsAnimals <- list.files(path = "data/tracking_db/data/sensors_animals/", pattern = glob2rx('*.csv'), full.names = TRUE)
sensors <- list.files(path = "data/tracking_db/data/sensors/", pattern = glob2rx('*.csv'), full.names = TRUE)
animals <- list.files(path = "data/tracking_db/data/animals/", pattern = glob2rx('*.csv'), full.names = TRUE)

# create dataframe

# specify column names for database tables
gpsDataColumnNames <- c("gpsSensorsCode","lineNo", "utcDate", "utcTime", "lmtDate", "lmtTime", "ecefX", "ecefY","ecefZ", "latitude", "longitude", 
"height", "dop", "nav", "validated", "satsUsed", "ch01SatId", "ch01SatCnr", "ch02SatId", "ch02SatCnr", "ch03SatId", "ch03SatCnr", "ch04SatId", "ch04SatCnr", "ch05SatId", "ch05SatCnr", "ch06SatId", "ch06SatCnr", "ch07SatId", "ch07SatCnr", "ch08SatId", "ch08SatCnr", "ch09SatId", "ch09SatCnr", "ch10SatId", "ch10SatCnr", "ch11SatId", "ch11SatCnr", "ch12SatId", "ch12SatCnr", "mainVol", "buVol", "temp", "easting", "northing", "remarks")
sensorsAnimalsColumnNames <- c("animalsId","gpsSensorsId","startTime","EndTime","notes")
sensorsColumnNames <-c("gpsSensorsId", "gpsSensorsCode", "purchaseDate", "frequency", "vendor","model","sim")
animalsColumnNames <- c("animalsId", "animalsCode", "name","sex","ageClassCode", "speciesCode")

# save data in database
saveDataInDB(gpsData, movementDB, "gpsData", gpsDataColumnNames, TRUE)
saveDataInDB(sensorsAnimals, movementDB, "sensorsAnimals", sensorsAnimalsColumnNames, FALSE)
saveDataInDB(sensors, movementDB, "sensors", sensorsColumnNames, FALSE)
saveDataInDB(animals, movementDB, "animals", animalsColumnNames, FALSE)
```

```{r}
# use data
#dbListTables(movementDB)
dbListFields(movementDB, "gpsData")
dbListFields(movementDB, "sensorsAnimals")
dbListFields(movementDB, "sensors")
dbListFields(movementDB, "animals")
#dbGetQuery(movementDB, 'SELECT "GPSSensorsCode", "latitude", "longitude" FROM GPSDATA WHERE #"GPSSensorsCode" in ("GSM01508", "GSM01438")')
```

The database can be queried with SQL. Since we want to link the GPS data with specific animals we need to join these tables. However, this was less straightforward than expeced, because these tables did not have any information in common. We therefore had to join all four tables to get to the combination of data we needed. We did this by embedding SQL statements. 

```{r}
# query data from database
query <- '
SELECT
animals.name,
animals.sex,
dataWithAnimalId.utcDate, dataWithAnimalId.utcTime, 
dataWithAnimalId.latitude, dataWithAnimalId.longitude,
dataWithAnimalId.height
FROM
  (SELECT 
  dataWithSensorId.gpsSensorsCode, 
  dataWithSensorId.utcDate, dataWithSensorId.utcTime, 
  dataWithSensorId.latitude, dataWithSensorId.longitude, 
  dataWithSensorId.height,
  dataWithSensorId.gpsSensorsId, 
  sensorsAnimals.animalsId 
  FROM 
    (SELECT 
    gpsData.gpsSensorsCode, 
    gpsData.utcDate, gpsData.utcTime, 
    gpsData.latitude, gpsData.longitude, 
    gpsData.height,
    sensors.gpsSensorsId 
    FROM 
    gpsData 
    LEFT JOIN 
    sensors ON gpsData.gpsSensorsCode = sensors.gpsSensorsCode) AS dataWithSensorId 
  LEFT JOIN 
  sensorsAnimals ON dataWithSensorId.gpsSensorsId = sensorsAnimals.gpsSensorsId) AS dataWithAnimalId 
LEFT JOIN
animals ON dataWithAnimalId.animalsId = animals.animalsId
;'

selectedMovementData <- dbGetQuery(movementDB, query)
```

At this point we have the data we need. However, all data is stored as strings. We thus have create a geometry out of the latitude and longitude columns, so that every row represents a point in space. We choose the WGS84 zone 32 (EPSG:32632) as coordinate system, since that gives enough detail for our analyses. 

```{r}
# correct classes
selectedMovementData$sex <- factor(selectedMovementData$sex)
class(selectedMovementData$latitude) <- "numeric"
class(selectedMovementData$longitude) <- "numeric"
class(selectedMovementData$height) <- "numeric"
selectedMovementData$date <- dmy_hms(paste(selectedMovementData$utcDate, selectedMovementData$utcTime), tz = "UTC")
# remove redundant columns
selectedMovementData[3:4] <- list(NULL)

# remove rows with NA for location
selectedMovementDataNoNA <- selectedMovementData[!is.na(selectedMovementData$latitude) | !is.na(selectedMovementData$longitude),]

# create spatial data frame project in WGS84 zone 32
coords <- selectedMovementDataNoNA[,c(4:3)]
proj4WGS84 <- "+proj=longlat +datum=WGS84 +no_defs"
proj4 <- "+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs"
WGS84movementSDF <- SpatialPointsDataFrame(coords = coords, data = selectedMovementDataNoNA, proj4string = CRS(proj4WGS84))
movementSDF <- spTransform(WGS84movementSDF, CRS(proj4))

# create trajectories
movementTrajectories <- as.ltraj(xy = coordinates(movementSDF), date = movementSDF$date, id = movementSDF$name)

# reproject rasters
DEM <- projectRaster(DEM, crs=proj4)
```

We are curious where our roe deer go to!

```{r}
# check data
plot(DEM)
lines(movementTrajectories[[1]])
lines(movementTrajectories[[2]], col = 'red')
lines(movementTrajectories[[3]], col = 'blue')
lines(movementTrajectories[[4]], col = 'purple')
lines(movementTrajectories[[5]], col = 'orange')

par(mfrow=c(3, 2))
hist(movementTrajectories[[1]]$dist, xlim = c(0, 2000), ylim = c(0, 1500), breaks = seq(0, 1000000, by = 100), xlab = "distance (m)", main = paste("Distance between relocations by", id(movementTrajectories)[1]))
hist(movementTrajectories[[2]]$dist, xlim = c(0, 2000), ylim = c(0, 1500), breaks = seq(0, 1000000, by = 100), xlab = "distance (m)", main = paste("Distance between relocations by", id(movementTrajectories)[2]))
hist(movementTrajectories[[3]]$dist, xlim = c(0, 2000), ylim = c(0, 1500), breaks = seq(0, 1000000, by = 100), xlab = "distance (m)", main = paste("Distance between relocations by", id(movementTrajectories)[3]))
hist(movementTrajectories[[4]]$dist, xlim = c(0, 2000), ylim = c(0, 1500), breaks = seq(0, 1000000, by = 100), xlab = "distance (m)", main = paste("Distance between relocations by", id(movementTrajectories)[4]))
hist(movementTrajectories[[5]]$dist, xlim = c(0, 2000), ylim = c(0, 1500), breaks = seq(0, 1000000, by = 100), xlab = "distance (m)", main = paste("Distance between relocations by", id(movementTrajectories)[5]))

# quantiles give a good indication of the distribution (around 4h between relocations)
quantile(diff(movementTrajectories[[1]][,'date']))
quantile(diff(movementTrajectories[[2]][,'date']))
quantile(diff(movementTrajectories[[3]][,'date']))
quantile(diff(movementTrajectories[[4]][,'date']))
quantile(diff(movementTrajectories[[5]][,'date']))

par(mfrow=c(1, 1))
hist(as.numeric(diff(movementTrajectories[[1]][,'date'])), xlim = c(0,5000), ylim = c(0,1000), breaks = seq(0, 10000000, by = 100), xlab = "time", main = paste("Time between relocations by" , id(movementTrajectories[1])))
hist(as.numeric(diff(movementTrajectories[[2]][,'date'])), xlim = c(0,5000), ylim = c(0,1000), breaks = seq(0, 10000000, by = 100), main = paste("Time between relocations by" , id(movementTrajectories[2])))

dataframeTrajectories <- ld(movementTrajectories)
groups <- dataframeTrajectories %>% group_by(id) %>% mutate(timeDifference = c(NA, diff(date)))
trajectories <- dl(groups)

# boxplots to find best variable to remove outliers
par(mfrow=c(3,2))
ggplot(groups, aes(x=id, y=dist, fill = id)) + geom_boxplot(alpha=0.2) + theme(legend.position = "none")
ggplot(groups, aes(x=id, y=timeDifference, fill = id)) + geom_boxplot(alpha=0.2) + theme(legend.position = "none")
ggplot(groups, aes(x=id, y=rel.angle, fill = id)) + geom_boxplot(alpha=0.2) + theme(legend.position = "none")
ggplot(groups, aes(x=id, y=abs.angle, fill = id)) + geom_boxplot(alpha=0.2) + theme(legend.position = "none")
ggplot(groups, aes(x=id, y=y, fill = id)) + geom_boxplot(alpha=0.2) + theme(legend.position = "none")
ggplot(groups, aes(x=id, y=x, fill = id)) + geom_boxplot(alpha=0.2) + theme(legend.position = "none")
```

The data clearly contains some outliers. These will need to be removed in order to perform reliable analyses.

```{r}
# clean data
# remove outliers based on x-coordinates and distance between relocations
groupsCleaned <- groups %>% filter(x < 700000) %>% filter(x > 650000) %>% filter(dist < 000)

#cast back to ltraj 
movementTrajectoriesCleaned <- dl(groupsCleaned)

# check data again
plot(DEM)
lines(movementTrajectoriesCleaned[[1]])
lines(movementTrajectoriesCleaned[[2]], col = 'red')
lines(movementTrajectoriesCleaned[[3]], col = 'blue')
lines(movementTrajectoriesCleaned[[4]], col = 'purple')
lines(movementTrajectoriesCleaned[[5]], col = 'orange')

# boxplots
ggplot(groupsCleaned, aes(x=id, y=dist, fill = id)) + geom_boxplot(alpha=0.2) + theme(legend.position = "none")
ggplot(groupsCleaned, aes(x=id, y=timeDifference, fill = id)) + geom_boxplot(alpha=0.2) + theme(legend.position = "none")
ggplot(groupsCleaned, aes(x=id, y=y, fill = id)) + geom_boxplot(alpha=0.2) + theme(legend.position = "none")
ggplot(groupsCleaned, aes(x=id, y=x, fill = id)) + geom_boxplot(alpha=0.2) + theme(legend.position = "none")

```



```{r}


```

```{r}
# disconnect database
dbDisconnect(movementDB)
```

## References
Urbano, F., & Cagnacci, F. (2014). Spatial database for GPS wildlife tracking data. Springer International Publishing.